<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∏ÖÂñÆÁ¥ÄÈåÑ</title>
    <!-- ËºâÂÖ• Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ËºâÂÖ• Lucide ÂúñÊ®ô -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- ËºâÂÖ• React Ê†∏ÂøÉ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ËºâÂÖ• Firebase (Compat ÁâàÊú¨) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- ËºâÂÖ• Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --ghibli-sky: #87CEEB;
            --ghibli-forest: #4A7C59;
            --ghibli-leaf: #A7C957;
            --ghibli-cream: #FDFCF0;
            --ghibli-wood: #6D4C41;
            --ghibli-accent: #FFB74D;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background-color: var(--ghibli-cream); 
            color: #3E2723;
            -webkit-font-smoothing: antialiased;
            background-image: radial-gradient(rgba(74, 124, 89, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .std-card {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #E9EED9;
            border-radius: 24px;
            box-shadow: 0 8px 0px rgba(74, 124, 89, 0.08);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nav-standard {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-top: 3px solid var(--ghibli-leaf);
        }

        .nav-active {
            color: var(--ghibli-forest);
            transform: scale(1.05);
        }
        .nav-active::after {
            content: 'üçÉ';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
        }

        input, select, textarea {
            border: 2px solid #E9EED9 !important;
            border-radius: 16px !important;
            padding: 10px 16px !important;
            background: #FFFFFF !important;
            font-weight: 600 !important;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--ghibli-leaf) !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(167, 201, 87, 0.1) !important;
        }

        .status-check {
            width: 32px;
            height: 32px;
            border: 3px solid #CBD5E1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .status-check.active {
            background: var(--ghibli-forest);
            border-color: var(--ghibli-forest);
        }

        .action-btn-sm {
            padding: 8px 14px;
            border-radius: 14px;
            transition: all 0.2s;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            border: 2px solid #E9EED9;
            background: #FFFFFF;
            gap: 6px;
            font-size: 13px;
            font-weight: 800;
            color: var(--ghibli-forest);
            box-shadow: 0 4px 0px #E9EED9;
        }
        .action-btn-sm:active { transform: translateY(3px); box-shadow: 0 1px 0px #E9EED9; }

        .ghibli-header {
            background: linear-gradient(180deg, var(--ghibli-sky) 0%, #BFEFFF 100%);
            border-bottom: 4px solid var(--ghibli-forest);
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .float-icon { animation: floating 4s ease-in-out infinite; }

        .modal-overlay {
            background: rgba(62, 39, 35, 0.5);
            backdrop-filter: blur(8px);
            position: fixed;
            inset: 0;
            z-index: 50;
        }

        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        
        .img-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #E9EED9;
        }
        .img-preview-large {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 16px;
            border: 2px solid #E9EED9;
            margin-top: 8px;
        }
        
        .date-error-badge {
            background: #FEF2F2;
            color: #EF4444;
            border: 1px solid #FEE2E2;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase ÈÖçÁΩÆ
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { 
                apiKey: "AIzaSyDcNgcQWZTg2UijNW7LS4AnC6XQqjIaNVM",
                authDomain: "ghibli-list.firebaseapp.com",
                projectId: "ghibli-list",
                storageBucket: "ghibli-list.firebasestorage.app",
                messagingSenderId: "730434760352",
                appId: "1:730434760352:web:23190ab321a6261905e3c5"
            };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : "ghibli-pro-app";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 18, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const container = document.createElement('div');
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    container.appendChild(i);
                    window.lucide.createIcons({
                        root: container,
                        attrs: { width: size, height: size, class: className }
                    });
                    setSvgHtml(container.innerHTML);
                }
            }, [name, size, className]);
            if (!svgHtml) return <span style={{ width: size, height: size, display: 'inline-block' }} className={className} />;
            return <span className="inline-flex shrink-0" dangerouslySetInnerHTML={{ __html: svgHtml }} />;
        };

        const GHIBLI_COLORS = [
            '#4A7C59', '#A7C957', '#FFB74D', '#F4A261', '#E9C46A', 
            '#264653', '#2A9D8F', '#E76F51', '#8AB17D', '#B8F2E6',
            '#606C38', '#283618', '#DDA15E', '#BC6C25', '#9E2A2B'
        ];

        // ÂúñÁâáÂ£ìÁ∏ÆÂáΩÂºè
        const compressImage = (base64Str, maxWidth = 1024, quality = 0.7) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            });
        };

        function App() {
            const [user, setUser] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [categories, setCategories] = useState([]);
            const [expenseItems, setExpenseItems] = useState([]); 
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('list'); 
            const [sortBy, setSortBy] = useState('date_asc'); 
            const [filterCat, setFilterCat] = useState('All');
            const [filterOwner, setFilterOwner] = useState('All');
            const [filterExpItem, setFilterExpItem] = useState('All'); 
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');
            const [filterKeyword, setFilterKeyword] = useState('');
            const [tempKeyword, setTempKeyword] = useState('');
            const [expandedHistory, setExpandedHistory] = useState({});

            const chartRefs = useRef({ trend: null, item: null });

            const [taskText, setTaskText] = useState('');
            const [owners, setOwners] = useState([]);
            const [category, setCategory] = useState('');
            const [note, setNote] = useState('');
            const [dateMode, setDateMode] = useState('single');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [links, setLinks] = useState([{ label: '', url: '' }]);
            const [images, setImages] = useState([]); 
            const [editingId, setEditingId] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            
            const [expenseModalTask, setExpenseModalTask] = useState(null);
            const [modalExpenses, setModalExpenses] = useState([]);
            const [showCatAdmin, setShowCatAdmin] = useState(false);
            const [showMemberAdmin, setShowMemberAdmin] = useState(false);
            const [showExpItemAdmin, setShowExpItemAdmin] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [newExpenseItemName, setNewExpenseItemName] = useState('');
            const [newMemberName, setNewMemberName] = useState('');

            // Èò≤ÈñÉÁàçËàáÂàùÂßãÂåñÈéñÂÆöÊ®ôË®ò
            const hasInitializedOwners = useRef(false);
            const hasCheckedMembersInDb = useRef(false);

            // Êó•ÊúüÈ©óË≠âÈÇèËºØ
            const isFilterDateInvalid = useMemo(() => filterStartDate && filterEndDate && filterEndDate < filterStartDate, [filterStartDate, filterEndDate]);
            const isAddDateInvalid = useMemo(() => dateMode === 'range' && startDate && endDate && endDate < startDate, [dateMode, startDate, endDate]);

            // Firebase ÁôªÂÖ•
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) { console.error("Auth Error:", err); }
                };
                initAuth();
                return auth.onAuthStateChanged(setUser);
            }, []);

            // Ë≥áÊñôÁõ£ËÅΩËàáÂêåÊ≠•
            useEffect(() => {
                if (!user) return;
                const path = db.collection('artifacts').doc(appId).collection('public').doc('data');
                
                // 1. ‰ªªÂãôÁõ£ËÅΩ
                const unsubTasks = path.collection('tasks').onSnapshot(snap => {
                    setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                });

                // 2. È°ûÂà•Áõ£ËÅΩ (‰øÆÊîπÔºöÁßªÈô§ serverTimestampÔºåÊîπÁî® ISOString)
                const unsubCats = path.collection('categories').onSnapshot(snap => {
                    let d = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (d.length === 0) {
                        ['Êó•Â∏∏', 'Â≠∏Áøí', 'ÁæéÈ£ü', 'ÊóÖÈÅä', 'ÂÅ•Â∫∑'].forEach((name, i) => 
                            path.collection('categories').add({ name, order: i, createdAt: new Date().toISOString() }));
                    } else {
                        const sorted = d.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
                        setCategories(sorted);
                        if (sorted.length > 0 && !category) setCategory(sorted[0].name);
                    }
                });

                // 3. Ë≤ªÁî®È†ÖÁõÆÁõ£ËÅΩ (‰øÆÊîπÔºöÁßªÈô§ serverTimestampÔºåÊîπÁî® ISOString)
                const unsubExpItems = path.collection('expenseItems').onSnapshot(snap => {
                    let d = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (d.length === 0) {
                        ['‰∫§ÈÄö', '‰ΩèÂÆø', 'ÈñÄÁ•®', 'È§êË≤ª', 'Ë≥ºÁâ©'].forEach((name, i) => 
                            path.collection('expenseItems').add({ name, order: i, createdAt: new Date().toISOString() }));
                    } else {
                        setExpenseItems(d.sort((a,b) => (a.order ?? 0) - (b.order ?? 0)));
                    }
                });

                // 4. ÊàêÂì°Áõ£ËÅΩ (ÁúüÊ≠£‰πæÊ∑®ÁâàÔºöÂæπÂ∫ïÁßªÈô§ÊâÄÊúâËá™ÂãïÂª∫Á´ãÈÇèËºØ)
                const unsubMembers = path.collection('members').onSnapshot(snap => {
                    const memberData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const sorted = memberData.sort((a,b) => (a.order ?? 0) - (b.order ?? 0));
                    
                    // ÁÑ°Ë´ñÊï∏ÊìöÂ¶Ç‰ΩïÔºåÁõ¥Êé•Êõ¥Êñ∞Êú¨Âú∞ÁãÄÊÖã„ÄÇÁµïÂ∞ç‰∏çÂÜçËá™ÂãïÂØ´ÂÖ• Terry/Eric„ÄÇ
                    setMembers(sorted);
                }, err => console.error("Members Listener Error:", err));

                return () => { unsubTasks(); unsubCats(); unsubExpItems(); unsubMembers(); };
            }, [user]);

            // ËôïÁêÜÊàêÂì°ÂàùÂßãÈÅ∏ÂèñÔºåÂÉÖÂü∑Ë°å‰∏ÄÊ¨°ÔºåÈÅøÂÖçÈñÉÁàç
            useEffect(() => {
                if (members.length > 0 && !hasInitializedOwners.current && owners.length === 0 && !editingId) {
                    setOwners([members[0].name]);
                    hasInitializedOwners.current = true;
                }
            }, [members, editingId]);

            const handleLinkAdd = () => setLinks([{ label: '', url: '' }, ...links]);

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = async (re) => {
                        const compressed = await compressImage(re.target.result);
                        setImages(prev => [...prev, compressed]);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handlePaste = async (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        const blob = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = async (re) => {
                            const compressed = await compressImage(re.target.result);
                            setImages(prev => [...prev, compressed]);
                        };
                        reader.readAsDataURL(blob);
                    }
                }
            };

            const toggleOwner = (name) => {
                if (owners.includes(name)) {
                    if (owners.length > 1) setOwners(owners.filter(o => o !== name));
                } else {
                    setOwners([...owners, name]);
                }
            };

            const handleAddMember = async () => {
                if (!newMemberName.trim() || !user) return;
                const path = db.collection('artifacts').doc(appId).collection('public').doc('data');
                try {
                    // Â∑≤‰øÆÊ≠£Ôºö‰ΩøÁî® ISOString
                    await path.collection('members').add({
                        name: newMemberName.trim(),
                        order: members.length,
                        createdAt: new Date().toISOString()
                    });
                    setNewMemberName('');
                } catch (err) { 
                    console.error("Add Member Error:", err);
                    alert("Êñ∞Â¢ûÂ§±ÊïóÔºåË´ãÊ™¢Êü•ÈÄ£Á∑ö„ÄÇ");
                }
            };

            const handleDeleteMember = async (id) => {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄô‰ΩçÊàêÂì°ÂóéÔºü")) return;
                const path = db.collection('artifacts').doc(appId).collection('public').doc('data');
                try {
                    await path.collection('members').doc(id).delete();
                } catch (err) { console.error(err); }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!taskText.trim() || isProcessing || !user || isAddDateInvalid) return;
                setIsProcessing(true);
                // Â∑≤‰øÆÊ≠£Ôºö‰ΩøÁî® ISOString
                const data = {
                    text: taskText.trim(), owners, category, note, dateMode, startDate, endDate: dateMode === 'range' ? endDate : '',
                    images, links: links.filter(l => l.url.trim() !== ''),
                    updatedAt: new Date().toISOString()
                };
                try {
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks');
                    // Â∑≤‰øÆÊ≠£Ôºö‰ΩøÁî® ISOString
                    if (editingId) await ref.doc(editingId).update(data);
                    else await ref.add({ ...data, completed: false, createdAt: new Date().toISOString() });
                    resetForm(); setActiveTab('list');
                } catch (err) {
                    console.error("Save Error:", err);
                    if (err.message.includes('longer than 1048487 bytes')) alert("ÂúñÁâáÈÅéÂ§öË∂ÖÂá∫ÂÆπÈáèÈôêÂà∂ÔºåË´ãÊ∏õÂ∞ëÂúñÁâáÊàñÂÇôË®ª„ÄÇ");
                    else alert("ÂÑ≤Â≠òÂ§±Êïó");
                }
                setIsProcessing(false);
            };

            const resetForm = () => {
                setTaskText(''); setNote(''); setStartDate(''); setEndDate(''); setImages([]);
                setLinks([{ label: '', url: '' }]); setEditingId(null); setDateMode('single'); 
                if (members.length > 0) setOwners([members[0].name]);
            };

            const startEdit = (t) => {
                setTaskText(t.text); 
                // Áõ∏ÂÆπÊ≠∑Âè≤ÂñÆ‰∏Ä owner Ê†ºÂºè
                setOwners(t.owners || (t.owner ? [t.owner] : (members.length > 0 ? [members[0].name] : []))); 
                setCategory(t.category); setNote(t.note || '');
                setStartDate(t.startDate || ''); setEndDate(t.endDate || ''); setImages(t.images || []);
                setLinks(t.links?.length ? t.links : [{ label: '', url: '' }]);
                setEditingId(t.id); setDateMode(t.dateMode || 'single'); setActiveTab('add');
            };

            const clearFilters = () => {
                setFilterCat('All'); setFilterOwner('All'); setFilterExpItem('All');
                setFilterStartDate(''); setFilterEndDate(''); setFilterKeyword(''); setTempKeyword('');
            };

            const handleDragStart = (e, index, type) => {
                e.dataTransfer.setData("dragIndex", index);
                e.dataTransfer.setData("dragType", type);
            };

            const handleDrop = async (e, dropIndex, type) => {
                const dragIndex = parseInt(e.dataTransfer.getData("dragIndex"));
                const dragType = e.dataTransfer.getData("dragType");
                if (dragType !== type || dragIndex === dropIndex) return;
                const list = type === 'cat' ? [...categories] : type === 'exp' ? [...expenseItems] : [...members];
                const [movedItem] = list.splice(dragIndex, 1);
                list.splice(dropIndex, 0, movedItem);
                const collectionName = type === 'cat' ? 'categories' : type === 'exp' ? 'expenseItems' : 'members';
                const batch = db.batch();
                list.forEach((item, idx) => {
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName).doc(item.id);
                    batch.update(ref, { order: idx });
                });
                await batch.commit();
            };

            const calculateTaskTotal = (t) => (t.expenses || []).reduce((s, i) => s + (parseFloat(i.amount) || 0), 0);

            // Ë≥áÊñôÈÅéÊøæÈÇèËºØ
            const sortedTasks = useMemo(() => {
                let res = [...tasks];
                if (filterCat !== 'All') res = res.filter(t => t.category === filterCat);
                // ÁØ©ÈÅ∏ÂêåÊôÇÁõ∏ÂÆπÊñ∞ËàäÊ†ºÂºè
                if (filterOwner !== 'All') res = res.filter(t => (t.owners || []).includes(filterOwner) || t.owner === filterOwner);
                if (filterExpItem !== 'All') res = res.filter(t => (t.expenses || []).some(e => e.item === filterExpItem));
                if (filterStartDate) res = res.filter(t => (t.startDate || '0000-00-00') >= filterStartDate);
                if (filterEndDate) res = res.filter(t => (t.startDate || '9999-99-99') <= filterEndDate);
                if (filterKeyword.trim()) {
                    const kw = filterKeyword.toLowerCase();
                    res = res.filter(t => t.text.toLowerCase().includes(kw) || (t.note && t.note.toLowerCase().includes(kw)));
                }
                res.sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    const d1 = a.startDate || (sortBy === 'date_asc' ? '9999-12-31' : '0000-01-01');
                    const d2 = b.startDate || (sortBy === 'date_asc' ? '9999-12-31' : '0000-01-01');
                    return sortBy === 'date_asc' ? d1.localeCompare(d2) : d2.localeCompare(d1);
                });
                return res;
            }, [tasks, filterCat, filterOwner, filterExpItem, filterStartDate, filterEndDate, filterKeyword, sortBy]);

            const analyticsData = useMemo(() => {
                const catMap = {}, ownerMap = {};
                let totalExpense = 0;
                sortedTasks.forEach(t => {
                    const total = calculateTaskTotal(t);
                    totalExpense += total;
                    catMap[t.category] = (catMap[t.category] || 0) + total;
                    const currentOwners = t.owners || (t.owner ? [t.owner] : []);
                    const splitAmount = currentOwners.length > 0 ? total / currentOwners.length : total;
                    currentOwners.forEach(o => { ownerMap[o] = (ownerMap[o] || 0) + splitAmount; });
                });
                const sortedCats = Object.entries(catMap).sort((a,b) => b[1] - a[1]);
                const sortedOwners = Object.entries(ownerMap).sort((a,b) => b[1] - a[1]);
                const colorMap = {};
                let colorIndex = 0;
                [...sortedCats, ...sortedOwners].forEach(([name]) => {
                    if (!colorMap[name]) { colorMap[name] = GHIBLI_COLORS[colorIndex % GHIBLI_COLORS.length]; colorIndex++; }
                });
                return { sortedCats, sortedOwners, totalExpense, colorMap };
            }, [sortedTasks]);

            const { sortedCats, sortedOwners, totalExpense, colorMap } = analyticsData;

            useEffect(() => {
                if (activeTab !== 'analytics' || sortedTasks.length === 0) return;
                const timer = setTimeout(() => {
                    if (chartRefs.current.trend) chartRefs.current.trend.destroy();
                    if (chartRefs.current.item) chartRefs.current.item.destroy();
                    const itemMap = {}, trendMap = {};
                    sortedTasks.forEach(t => {
                        (t.expenses || []).forEach(e => {
                            if (e.item) itemMap[e.item] = (itemMap[e.item] || 0) + parseFloat(e.amount || 0);
                            if (e.date) {
                                const key = e.date.substring(0, 7);
                                trendMap[key] = (trendMap[key] || 0) + parseFloat(e.amount || 0);
                            }
                        });
                    });
                    const trendKeys = Object.keys(trendMap).sort();
                    const trendCtx = document.getElementById('trendChart')?.getContext('2d');
                    if (trendCtx) chartRefs.current.trend = new Chart(trendCtx, {
                        type: 'bar',
                        data: { labels: trendKeys, datasets: [{ data: trendKeys.map(k => trendMap[k]), backgroundColor: '#4A7C59', borderRadius: 8 }] },
                        options: { plugins: { legend: { display: false } } }
                    });
                    const itemCtx = document.getElementById('itemChart')?.getContext('2d');
                    if (itemCtx) {
                        const sortedItems = Object.entries(itemMap).sort((a,b) => b[1] - a[1]);
                        chartRefs.current.item = new Chart(itemCtx, {
                            type: 'bar',
                            data: { labels: sortedItems.map(x=>x[0]), datasets: [{ data: sortedItems.map(x=>x[1]), backgroundColor: GHIBLI_COLORS }] },
                            options: { indexAxis: 'y', plugins: { legend: { display: false } } }
                        });
                    }
                }, 100);
                return () => clearTimeout(timer);
            }, [activeTab, sortedTasks]);

            const renderProgressList = (dataList, total) => {
                if (total === 0) return <div className="text-center text-slate-300 text-xs py-4 font-bold">Â∞öÁÑ°ÊîØÂá∫Ë≥áÊñô</div>;
                return (
                    <div className="space-y-4">
                        {dataList.map(([name, value]) => {
                            const percentage = ((value / total) * 100).toFixed(1);
                            return (
                                <div key={name} className="animate-fade-in">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs font-black text-slate-700 flex items-center gap-2">
                                            <span className="w-3 h-3 rounded-full" style={{backgroundColor: colorMap[name]}}></span>{name}
                                        </span>
                                        <span className="text-xs font-black text-slate-500">{percentage}% (${value.toLocaleString()})</span>
                                    </div>
                                    <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                        <div className="h-2.5 rounded-full transition-all duration-500" style={{ width: `${percentage}%`, backgroundColor: colorMap[name] }}></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            return (
                <div className="max-w-2xl mx-auto min-h-screen flex flex-col bg-[#FDFCF0]">
                    <header className="ghibli-header px-6 py-8 flex flex-col items-center justify-center sticky top-0 z-30 shadow-md">
                        <div className="flex items-center gap-3">
                            <div className="bg-white/40 p-2 rounded-full border-2 border-white/50 backdrop-blur-sm float-icon">
                                <Icon name="leaf" size={24} className="text-emerald-700" />
                            </div>
                            <h1 className="text-2xl font-black text-emerald-950 tracking-widest drop-shadow-sm">Ê∏ÖÂñÆÁ¥ÄÈåÑ</h1>
                        </div>
                        <Icon name="cloud" className="absolute top-2 right-6 text-white/40" size={50} />
                    </header>

                    <main className="flex-grow px-5 py-6 pb-36">
                        {activeTab === 'list' || activeTab === 'history' ? (
                            <div className="animate-fade-in">
                                <div className="flex flex-col gap-4 mb-8 bg-white p-6 rounded-[2rem] border-2 border-[#E9EED9] shadow-sm relative overflow-hidden">
                                    <Icon name="wind" className="absolute -top-2 -right-2 text-emerald-50 opacity-50" size={60} />
                                    <div className="flex items-center justify-between gap-2 z-10">
                                        <div className="w-[280px] flex items-center bg-[#F9FBF2] rounded-full px-4 border border-[#E9EED9] shadow-inner">
                                            <input type="text" value={tempKeyword} onChange={e => setTempKeyword(e.target.value)}
                                                onKeyDown={e => e.key === 'Enter' && setFilterKeyword(tempKeyword)} placeholder="ÈóúÈçµÂ≠ó..." className="w-full bg-transparent border-none text-[11px] font-black p-2 outline-none" />
                                            <button onClick={() => setFilterKeyword(tempKeyword)} className="p-1.5 text-emerald-500 hover:text-emerald-700 transition-colors"><Icon name="search" size={16} /></button>
                                        </div>
                                        <button onClick={clearFilters} className="text-[10px] bg-rose-50 text-rose-500 font-black px-4 py-2.5 rounded-full whitespace-nowrap shadow-sm">Ê∏ÖÁ©∫ÁØ©ÈÅ∏</button>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 z-10">
                                        <select value={filterCat} onChange={e => setFilterCat(e.target.value)} className="text-xs bg-[#F9FBF2] font-black border-none !py-2 rounded-full px-4 min-w-[100px]"><option value="All">È°ûÂà•ÁØ©ÈÅ∏</option>{categories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}</select>
                                        <select value={filterOwner} onChange={e => setFilterOwner(e.target.value)} className="text-xs bg-[#F9FBF2] font-black border-none !py-2 rounded-full px-4 min-w-[100px]">
                                            <option value="All">ÊàêÂì°ÈÅ∏Êìá</option>
                                            {members.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}
                                        </select>
                                        <select value={filterExpItem} onChange={e => setFilterExpItem(e.target.value)} className="text-xs bg-[#F9FBF2] font-black border-none !py-2 rounded-full px-4 min-w-[100px]"><option value="All">Ë≤ªÁî®ÁØ©ÈÅ∏</option>{expenseItems.map(item => <option key={item.id} value={item.name}>{item.name}</option>)}</select>
                                        <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="text-xs bg-[#F9FBF2] font-black border-none !py-2 rounded-full px-4 min-w-[100px]"><option value="date_asc">Êó•ÊúüËàäËá≥Êñ∞</option><option value="date_desc">Êó•ÊúüÊñ∞Ëá≥Ëàä</option></select>
                                    </div>
                                    <div className="flex flex-col gap-1 pt-3 border-t border-[#F1F5E9] z-10">
                                        <div className="flex items-center gap-2">
                                            <Icon name="calendar" size={14} className="text-emerald-600" />
                                            <div className="flex items-center gap-2 w-full font-black">
                                                <input type="date" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} className={`text-xs w-full bg-[#F9FBF2] border-none !p-1.5 rounded-lg ${isFilterDateInvalid ? 'ring-2 ring-rose-300' : ''}`} />
                                                <span className="text-emerald-200">~</span>
                                                <input type="date" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} className={`text-xs w-full bg-[#F9FBF2] border-none !p-1.5 rounded-lg ${isFilterDateInvalid ? 'ring-2 ring-rose-300' : ''}`} />
                                            </div>
                                        </div>
                                        {isFilterDateInvalid && <div className="mt-1 flex justify-center"><span className="date-error-badge"><Icon name="alert-circle" size={12} /> ÁµêÊùüÊó•Êúü‰∏çÂèØÊó©ÊñºÈñãÂßãÊó•Êúü</span></div>}
                                    </div>
                                </div>

                                {sortedTasks.filter(t => (activeTab === 'list' ? !t.completed : t.completed)).map(t => {
                                    const isExpanded = expandedHistory[t.id];
                                    const total = calculateTaskTotal(t);
                                    const currentOwners = t.owners || (t.owner ? [t.owner] : []);
                                    return (
                                        <div key={t.id} className={`std-card mb-4 p-5 overflow-hidden ${t.completed ? 'opacity-70 grayscale-[0.3]' : ''}`}>
                                            <div className="flex items-start gap-4">
                                                <div onClick={() => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(t.id).update({ completed: !t.completed, completedAt: !t.completed ? new Date().toISOString() : null })}
                                                    className={`status-check flex-shrink-0 shadow-sm ${t.completed ? 'active' : ''}`}><Icon name="check" size={14} color="white" /></div>
                                                <div className="flex-grow cursor-pointer" onClick={() => setExpandedHistory({...expandedHistory, [t.id]: !isExpanded})}>
                                                    <div className="flex flex-wrap items-center gap-2 mb-1">
                                                        <h3 className="text-lg font-black text-slate-800 tracking-tight">{t.text}</h3>
                                                        <div className="flex gap-1">
                                                            {currentOwners.map(o => <span key={o} className="text-[9px] bg-indigo-50 text-indigo-500 px-2 py-0.5 rounded-full font-bold">{o}</span>)}
                                                            <span className="text-[9px] bg-slate-100 px-2 py-0.5 rounded-full font-bold">{t.category}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-4 text-[10px] font-bold text-slate-400">
                                                        {(t.startDate || t.dueDate) && <span className="flex items-center gap-1"><Icon name="calendar" size={10} /> {t.startDate} {t.endDate && `~ ${t.endDate}`}</span>}
                                                        {total > 0 && <span className="text-amber-600 font-black">${total.toLocaleString()}</span>}
                                                    </div>
                                                </div>
                                                <Icon name={isExpanded ? "chevron-up" : "chevron-down"} size={16} className="text-slate-300 mt-2" />
                                            </div>
                                            {isExpanded && (
                                                <div className="mt-4 pt-4 border-t border-slate-50 space-y-4 animate-in slide-in-from-top-2">
                                                    {t.note && <div className="text-sm text-slate-500 bg-[#FDFCF0] p-4 rounded-xl whitespace-pre-line border border-[#E9EED9]">{t.note}</div>}
                                                    {t.images && t.images.length > 0 && <div className="flex flex-wrap gap-2">{t.images.map((img, idx) => <img key={idx} src={img} className="img-preview-large" alt="ÈôÑ‰ª∂ÂúñÁâá" />)}</div>}
                                                    {t.links && t.links.length > 0 && <div className="flex flex-wrap gap-2">{t.links.map((l, i) => <a key={i} href={l.url} target="_blank" className="text-[10px] bg-white border border-emerald-100 text-emerald-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-2"><Icon name="link" size={10} /> {l.label || "ÈÄ£Áµê"}</a>)}</div>}
                                                    {t.expenses && t.expenses.length > 0 && (
                                                        <div className="bg-amber-50/30 p-3 rounded-xl">
                                                            <p className="text-[10px] font-black text-amber-600 mb-2">Ë≤ªÁî®ÊòéÁ¥∞</p>
                                                            {t.expenses.map((e, idx) => (
                                                                <div key={idx} className="flex justify-between text-[11px] py-1 border-b border-white/50 last:border-0"><span className="text-slate-500">{e.date} {e.item} {e.desc && `(${e.desc})`}</span><span className="font-black text-slate-700">${parseFloat(e.amount).toLocaleString()}</span></div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    <div className="flex justify-end gap-3 pt-2">
                                                        {!t.completed && <button onClick={() => { setExpenseModalTask(t); setModalExpenses(t.expenses || []); }} className="action-btn-sm text-amber-600"><Icon name="wallet" size={16} /><span>Ë≤ªÁî®</span></button>}
                                                        {!t.completed && <button onClick={() => startEdit(t)} className="action-btn-sm text-indigo-600"><Icon name="edit-3" size={16} /><span>‰øÆÊîπ</span></button>}
                                                        <button onClick={() => confirm("Ë¶ÅÂà™Èô§ÂóéÔºü") && db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(t.id).delete()} className="action-btn-sm text-rose-400"><Icon name="trash-2" size={16} /><span>Âà™Èô§</span></button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        ) : activeTab === 'add' ? (
                            <div className="std-card p-8 animate-fade-in relative overflow-hidden">
                                <h2 className="text-xl font-black text-emerald-950 flex items-center gap-3 mb-8"><Icon name="plus-circle" size={24} className="text-emerald-600" />Ë®òÈåÑ‰∫ãÈ†Ö</h2>
                                <form onSubmit={handleSubmit} className="space-y-6">
                                    <div><label className="text-[10px] font-black text-emerald-600 uppercase mb-2 block tracking-widest">‰∫ãÈ†ÖÂêçÁ®±</label><input className="w-full text-lg font-black" value={taskText} onChange={e => setTaskText(e.target.value)} placeholder="Ë¶ÅÂÅö‰ªÄÈ∫ºÔºü" required /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="text-[10px] font-black text-emerald-600 uppercase tracking-widest">ÊàêÂì° (Â§öÈÅ∏)</label>
                                                <button type="button" onClick={()=>setShowMemberAdmin(!showMemberAdmin)} className="text-[10px] text-emerald-500 font-bold underline">ÁÆ°ÁêÜ</button>
                                            </div>
                                            <div className="flex flex-wrap gap-2">
                                                {members.length === 0 ? (
                                                    <p className="text-[10px] text-slate-300 font-bold py-2 italic tracking-tighter">Ë´ãÈªûÈÅ∏ÁÆ°ÁêÜÊñ∞Â¢ûÊàêÂì°</p>
                                                ) : (
                                                    members.map(m => <button key={m.id} type="button" onClick={() => toggleOwner(m.name)} className={`px-4 py-2 rounded-xl text-xs font-black border-2 transition-all ${owners.includes(m.name) ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-indigo-400 border-indigo-50'}`}>{m.name}</button>)
                                                )}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between items-center mb-2"><label className="text-[10px] font-black text-emerald-600 uppercase tracking-widest">È°ûÂà•</label><button type="button" onClick={()=>setShowCatAdmin(!showCatAdmin)} className="text-[10px] text-emerald-500 font-bold underline">ÁÆ°ÁêÜ</button></div>
                                            <select className="w-full font-black text-sm" value={category} onChange={e => setCategory(e.target.value)}>{categories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}</select>
                                        </div>
                                    </div>

                                    {showMemberAdmin && (
                                        <div className="p-4 bg-indigo-50/50 rounded-2xl border-2 border-indigo-100 border-dashed animate-fade-in shadow-inner">
                                            <p className="text-[9px] font-bold text-indigo-400 mb-2 uppercase tracking-widest">Á∂≠Ë≠∑ÊàêÂì°ÂêçÂñÆ (ÊãñÊõ≥ÊéíÂ∫è)</p>
                                            <div className="flex flex-wrap gap-2 mb-4">
                                                {members.map((m, idx) => (
                                                    <span key={m.id} draggable onDragStart={(e)=>handleDragStart(e, idx, 'member')} onDragOver={(e)=>e.preventDefault()} onDrop={(e)=>handleDrop(e, idx, 'member')} className="bg-white border px-3 py-1 rounded-full text-[10px] font-black flex items-center gap-2 drag-handle shadow-sm">
                                                        {m.name}
                                                        <button type="button" onClick={()=>handleDeleteMember(m.id)} className="text-rose-300 hover:text-rose-500 transition-colors"><Icon name="x" size={10} /></button>
                                                    </span>
                                                ))}
                                            </div>
                                            <div className="flex gap-2">
                                                <input className="flex-grow !py-1 text-xs font-bold" placeholder="Êñ∞ÊàêÂì°ÂßìÂêç" value={newMemberName} onChange={e=>setNewMemberName(e.target.value)} />
                                                <button type="button" onClick={handleAddMember} className="bg-indigo-600 text-white px-4 rounded-xl text-xs font-black shadow-md hover:bg-indigo-700 transition-all">Êñ∞Â¢û</button>
                                            </div>
                                        </div>
                                    )}

                                    {showCatAdmin && (
                                        <div className="p-4 bg-emerald-50/50 rounded-2xl border-2 border-emerald-100 border-dashed animate-fade-in shadow-inner">
                                            <div className="flex flex-wrap gap-2 mb-4">{categories.map((cat, idx) => (<span key={cat.id} draggable onDragStart={(e)=>handleDragStart(e, idx, 'cat')} onDragOver={(e)=>e.preventDefault()} onDrop={(e)=>handleDrop(e, idx, 'cat')} className="bg-white border px-3 py-1 rounded-full text-[10px] font-black flex items-center gap-2 drag-handle shadow-sm">{cat.name}<button type="button" onClick={()=>db.collection('artifacts').doc(appId).collection('public').doc('data').collection('categories').doc(cat.id).delete()} className="text-rose-300 hover:text-rose-500 transition-colors"><Icon name="x" size={10} /></button></span>))}</div>
                                            <div className="flex gap-2"><input className="flex-grow !py-1 text-xs font-bold" placeholder="Êñ∞È°ûÂà•ÂêçÁ®±" value={newCategoryName} onChange={e=>setNewCategoryName(e.target.value)} /><button type="button" onClick={()=>{ if(!newCategoryName.trim()) return; db.collection('artifacts').doc(appId).collection('public').doc('data').collection('categories').add({name: newCategoryName.trim(), order: categories.length, createdAt: new Date().toISOString()}); setNewCategoryName(''); }} className="bg-emerald-600 text-white px-4 rounded-xl text-xs font-black shadow-md hover:bg-emerald-700 transition-colors">Êñ∞Â¢û</button></div>
                                        </div>
                                    )}

                                    <div>
                                        <label className="text-[10px] font-black text-emerald-600 uppercase mb-3 block tracking-widest">Êó•ÊúüË®≠ÂÆö</label>
                                        <div className="flex gap-2 mb-3">{['single', 'range'].map(m => <button key={m} type="button" onClick={() => setDateMode(m)} className={`flex-1 py-2 rounded-xl text-xs font-black transition-all ${dateMode === m ? 'bg-emerald-600 text-white shadow-md' : 'bg-white text-emerald-500 border-emerald-100'}`}>{m === 'single' ? "ÂñÆÊó•" : "ÂçÄÈñì"}</button>)}</div>
                                        <div className={`grid grid-cols-2 gap-3 p-4 bg-[#F9FBF2] rounded-[1.5rem] border transition-all ${isAddDateInvalid ? 'border-rose-400 shadow-[inset_0_0_10px_rgba(239,68,68,0.1)]' : 'border-emerald-50 shadow-inner'}`}>
                                            <div><label className="text-[9px] text-slate-400 block mb-1 uppercase font-bold">ÈñãÂßãÊó•Êúü</label><input type="date" className="w-full !p-1 text-xs font-black bg-transparent border-none" value={startDate} onChange={e => setStartDate(e.target.value)} /></div>
                                            {dateMode === 'range' && <div><label className="text-[9px] text-slate-400 block mb-1 uppercase font-bold">ÁµêÊùüÊó•Êúü</label><input type="date" className="w-full !p-1 text-xs font-black bg-transparent border-none" value={endDate} onChange={e => setEndDate(e.target.value)} /></div>}
                                        </div>
                                        {isAddDateInvalid && <div className="mt-2 text-center animate-bounce"><span className="date-error-badge"><Icon name="alert-triangle" size={12} /> ÁµêÊùüÊó•Êúü‰∏çËÉΩÊó©ÊñºÈñãÂßãÊó•Êúü</span></div>}
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-3"><label className="text-[10px] font-black text-emerald-600 uppercase tracking-widest">Áõ∏ÈóúÈÄ£ÁµêË≥áÊ∫ê</label><button type="button" onClick={handleLinkAdd} className="text-[10px] text-indigo-600 font-bold underline">+ Êñ∞Â¢ûÈÄ£Áµê</button></div>
                                        <div className="space-y-2">{links.map((li, i) => (<div key={i} className="flex gap-2 items-center p-2 bg-white border rounded-xl animate-fade-in shadow-sm"><input className="w-24 !p-1.5 text-[11px] bg-slate-50 font-bold rounded-lg" placeholder="Ê®ôÁ±§" value={li.label} onChange={e => { const n = [...links]; n[i].label = e.target.value; setLinks(n); }} /><input className="flex-grow !p-1.5 text-[11px] bg-slate-50 text-indigo-500 font-black rounded-lg" placeholder="https://..." value={li.url} onChange={e => { const n = [...links]; n[i].url = e.target.value; setLinks(n); }} /><button type="button" onClick={() => setLinks(links.filter((_, idx) => idx !== i))} className="p-1 text-rose-300 hover:text-rose-500 transition-colors"><Icon name="trash-2" size={14} /></button></div>))}</div>
                                    </div>

                                    <div><label className="text-[10px] font-black text-emerald-600 uppercase mb-3 block tracking-widest">ÂúñÁâáÈôÑ‰ª∂ (ÂèØÂ§öÂºµÊàñË≤º‰∏ä)</label>
                                        <div onPaste={handlePaste} className="relative group border-2 border-dashed border-[#E9EED9] rounded-2xl p-4 bg-white hover:bg-emerald-50/30 transition-all flex flex-col items-center">
                                            <div className="flex flex-wrap gap-2 mb-3 w-full justify-center">
                                                {images.map((img, idx) => (<div key={idx} className="relative group/item"><img src={img} className="img-preview shadow-sm" alt="È†êË¶Ω" /><button type="button" onClick={()=>setImages(images.filter((_, i)=>i!==idx))} className="absolute -top-2 -right-2 bg-white text-rose-500 rounded-full p-1 shadow-md border opacity-0 group-hover/item:opacity-100 transition-opacity"><Icon name="x" size={10} /></button></div>))}
                                                <div className="w-20 h-20 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-slate-300 hover:text-emerald-400 hover:border-emerald-400 transition-all cursor-pointer relative shadow-sm shadow-inner"><Icon name="image-plus" size={24} /><input type="file" accept="image/*" multiple onChange={handleImageUpload} className="absolute inset-0 opacity-0 cursor-pointer" /></div>
                                            </div>
                                            <p className="text-[9px] font-bold text-center text-slate-400 uppercase tracking-widest">ÈªûÈÅ∏Âä†Ëôü‰∏äÂÇ≥ÊàñÂú®Ê≠§ Ctrl+V Ë≤º‰∏äÊà™Âúñ</p>
                                        </div>
                                    </div>

                                    <div><label className="text-[10px] font-black text-emerald-600 uppercase mb-2 block tracking-widest">Ë©≥Á¥∞ÂÇôË®ªÂÖßÂÆπ</label><textarea className="w-full min-h-[120px] text-sm font-bold bg-[#F9FBF2] rounded-[1.5rem] shadow-inner border-none p-5" value={note} onChange={e => setNote(e.target.value)} placeholder="Ëº∏ÂÖ•Á¥∞ÁØÄÊàñÁ≠ÜË®ò..." /></div>
                                    
                                    <button type="submit" disabled={isProcessing || isAddDateInvalid} className={`w-full h-14 rounded-[1.5rem] font-black shadow-lg transition-all flex items-center justify-center gap-3 tracking-widest ${isAddDateInvalid ? 'bg-slate-300 text-slate-500 cursor-not-allowed shadow-none' : 'bg-emerald-600 text-white shadow-emerald-100 hover:bg-emerald-700 active:scale-[0.98]'}`}>
                                        {isProcessing ? <Icon name="loader" className="animate-spin" /> : <Icon name="sparkles" size={20} />}{editingId ? "ÂÑ≤Â≠ò‰øÆÊîπ" : "Êñ∞Â¢û‰∫ãÈ†Ö"}
                                    </button>
                                </form>
                            </div>
                        ) : activeTab === 'analytics' ? (
                            <div className="animate-fade-in space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="std-card p-5 text-center"><p className="text-[10px] text-slate-400 mb-1">ÂçÄÂüüÈ†ÖÁõÆ</p><p className="text-2xl font-black">{sortedTasks.length}</p></div>
                                    <div className="std-card p-5 text-center"><p className="text-[10px] text-slate-400 mb-1">Ëä±Ë≤ªÁ∏ΩË®à</p><p className="text-2xl font-black text-indigo-600">${totalExpense.toLocaleString()}</p></div>
                                </div>
                                <div className="std-card p-6 shadow-sm"><h3 className="text-xs font-black mb-4 flex items-center gap-2 text-slate-500 tracking-widest uppercase"><Icon name="trending-up" className="text-indigo-600" /> ÊúàÂ∫¶ÊîØÂá∫Ë∂®Âã¢</h3><div className="h-48"><canvas id="trendChart"></canvas></div></div>
                                <div className="std-card p-6 shadow-sm"><h3 className="text-xs font-black mb-4 flex items-center gap-2 text-slate-500 tracking-widest uppercase"><Icon name="pie-chart" className="text-indigo-600" /> È°ûÂà•ÂàÜ‰Ωà‰ΩîÊØî</h3>{renderProgressList(sortedCats, totalExpense)}</div>
                                <div className="std-card p-6 shadow-sm"><h3 className="text-xs font-black mb-4 flex items-center gap-2 text-slate-500 tracking-widest uppercase"><Icon name="users" className="text-indigo-600" /> ÊàêÂì°ÊîØÂá∫Áµ±Ë®à (Âπ≥ÂùáÂàÜÊî§)</h3>{renderProgressList(sortedOwners, totalExpense)}</div>
                                <div className="std-card p-6 shadow-sm"><h3 className="text-xs font-black mb-4 flex items-center gap-2 text-slate-500 tracking-widest uppercase"><Icon name="bar-chart-2" className="text-indigo-600" /> È†ÖÁõÆÊîØÂá∫ÊéíË°åÊ¶ú</h3><div className="h-64"><canvas id="itemChart"></canvas></div></div>
                            </div>
                        ) : null}
                    </main>

                    {/* Ë≤ªÁî®Á∂≠Ë≠∑ÂΩàÁ™ó */}
                    {expenseModalTask && (
                        <div className="modal-overlay flex items-center justify-center p-6 animate-in zoom-in-95 duration-200" onClick={() => setExpenseModalTask(null)}>
                            <div className="bg-white w-full max-w-md p-8 rounded-[2.5rem] shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h3 className="font-black flex items-center gap-3 text-slate-800"><div className="bg-amber-100 p-2 rounded-xl text-amber-600"><Icon name="coins" size={20} /></div> Ë≤ªÁî®Á¥∞ÁØÄÁ∂≠Ë≠∑</h3><button onClick={() => setExpenseModalTask(null)} className="p-1 hover:bg-slate-100 rounded-full transition-colors"><Icon name="x" size={20} className="text-slate-300" /></button></div>
                                <div className="mb-4">
                                    <div className="flex justify-between items-center mb-2"><label className="text-[9px] font-black text-slate-400 uppercase tracking-wider">ÁÆ°ÁêÜÂ∏∏Áî®È†ÖÁõÆ</label><button onClick={() => setShowExpItemAdmin(!showExpItemAdmin)} className="text-[9px] text-indigo-500 font-bold underline">{showExpItemAdmin ? "ÂÆåÊàê" : "ÁÆ°ÁêÜ"}</button></div>
                                    {showExpItemAdmin && (
                                        <div className="p-3 bg-amber-50/50 rounded-xl border border-amber-100 mb-3 animate-fade-in">
                                            <div className="flex flex-wrap gap-1.5 mb-2">{expenseItems.map((item, idx) => (<span key={item.id} draggable onDragStart={(e)=>handleDragStart(e, idx, 'exp')} onDragOver={(e)=>e.preventDefault()} onDrop={(e)=>handleDrop(e, idx, 'exp')} className="bg-white border px-2 py-0.5 rounded-lg text-[9px] font-black flex items-center gap-1.5 drag-handle shadow-sm">{item.name}<button onClick={() => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenseItems').doc(item.id).delete()} className="text-rose-300 hover:text-rose-500 transition-colors"><Icon name="x" size={10} /></button></span>))}</div>
                                            <div className="flex gap-2"><input className="flex-grow !py-1 text-[10px] rounded-lg border-amber-100 font-bold" placeholder="Êñ∞È†ÖÁõÆÂêçÁ®±" value={newExpenseItemName} onChange={e => setNewExpenseItemName(e.target.value)} /><button onClick={()=>{ if(!newExpenseItemName.trim()) return; db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenseItems').add({name: newExpenseItemName.trim(), order: expenseItems.length, createdAt: new Date().toISOString()}); setNewExpenseItemName(''); }} className="bg-amber-500 text-white px-3 rounded-lg text-[10px] font-black shadow hover:bg-amber-600 transition-all">Êñ∞Â¢û</button></div>
                                        </div>
                                    )}
                                </div>
                                <div className="max-h-[40vh] overflow-y-auto pr-1 no-scrollbar mb-6 space-y-3 shadow-inner p-2 rounded-2xl bg-slate-50/50">
                                    {modalExpenses.length === 0 && <div className="text-center py-10 text-slate-300 text-xs font-bold border-2 border-dashed border-slate-100 rounded-3xl">Â∞öÊú™Á¥ÄÈåÑË≤ªÁî®</div>}
                                    {modalExpenses.map((ex, i) => (
                                        <div key={i} className="p-4 bg-white rounded-[1.5rem] relative space-y-3 border border-slate-100 shadow-sm animate-fade-in">
                                            <div className="grid grid-cols-2 gap-3">
                                                <input type="date" value={ex.date} onChange={e => { const n = [...modalExpenses]; n[i].date = e.target.value; setModalExpenses(n); }} className="w-full !p-1.5 text-[10px] font-black rounded-lg border-none bg-slate-50" />
                                                <input type="number" placeholder="ÈáëÈ°ç" value={ex.amount} onChange={e => { const n = [...modalExpenses]; n[i].amount = e.target.value; setModalExpenses(n); }} className="w-full !p-1.5 text-[10px] font-black text-indigo-600 rounded-lg border-none bg-slate-50" />
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <select value={ex.item} onChange={e => { const n = [...modalExpenses]; n[i].item = e.target.value; setModalExpenses(n); }} className="w-full !p-1.5 text-[10px] font-black rounded-lg border-none bg-slate-50">
                                                    <option value="">ÈÅ∏ÊìáÈ†ÖÁõÆ...</option>{expenseItems.map(opt => <option key={opt.id} value={opt.name}>{opt.name}</option>)}<option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                                                </select>
                                                <input placeholder="ÂÇôË®ª" value={ex.desc} onChange={e => { const n = [...modalExpenses]; n[i].desc = e.target.value; setModalExpenses(n); }} className="w-full !p-1.5 text-[10px] rounded-lg border-none bg-slate-50" />
                                            </div>
                                            <button onClick={() => setModalExpenses(modalExpenses.filter((_, idx) => idx !== i))} className="absolute -top-2 -right-2 bg-white text-rose-400 rounded-full p-1.5 shadow-md border hover:bg-rose-50 transition-colors"><Icon name="x" size={12} /></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setModalExpenses([{ date: new Date().toISOString().split('T')[0], item: '', desc: '', amount: '' }, ...modalExpenses])} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl text-xs font-black border border-slate-200 hover:bg-slate-200 transition-all">+ Êñ∞Â¢ûË≤ªÁî®</button>
                                    <button onClick={async () => { if (!user) return; await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(expenseModalTask.id).update({ expenses: modalExpenses.filter(e => e.amount) }); setExpenseModalTask(null); }} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl text-xs font-black shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">ÂÑ≤Â≠òÂÖßÂÆπ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 nav-standard h-20 flex items-center z-40 px-6 shadow-[0_-10px_30px_rgba(74,124,89,0.05)]">
                        <div className="max-w-xl mx-auto w-full grid grid-cols-4 gap-2 text-center font-black">
                            <button onClick={() => setActiveTab('list')} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab === 'list' ? 'nav-active' : 'text-slate-300'}`}><Icon name="layout-list" size={24} /><span className="text-[10px]">Ê∏ÖÂñÆ</span></button>
                            <button onClick={() => { resetForm(); setActiveTab('add'); }} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab === 'add' ? 'nav-active' : 'text-slate-300'}`}><Icon name="plus-square" size={24} /><span className="text-[10px]">Êñ∞Â¢û</span></button>
                            <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab === 'history' ? 'nav-active' : 'text-slate-300'}`}><Icon name="clock" size={24} /><span className="text-[10px]">Á¥ÄÈåÑ</span></button>
                            <button onClick={() => setActiveTab('analytics')} className={`flex flex-col items-center justify-center gap-1 transition-all duration-300 ${activeTab === 'analytics' ? 'nav-active' : 'text-slate-300'}`}><Icon name="pie-chart" size={24} /><span className="text-[10px]">Áµ±Ë®à</span></button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
