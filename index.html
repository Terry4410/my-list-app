<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…å–®ç´€éŒ„ - å‰åœåŠ›å¤¢å¹»ç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide åœ–æ¨™ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- è¼‰å…¥ React æ ¸å¿ƒ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- è¼‰å…¥ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- è¼‰å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --ghibli-sky: #87CEEB;
            --ghibli-forest: #4A7C59;
            --ghibli-leaf: #A7C957;
            --ghibli-cream: #FDFCF0;
            --ghibli-wood: #6D4C41;
            --ghibli-accent: #FFB74D;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background-color: var(--ghibli-cream); 
            color: #3E2723;
            -webkit-font-smoothing: antialiased;
            background-image: radial-gradient(rgba(74, 124, 89, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .std-card {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #E9EED9;
            border-radius: 24px;
            box-shadow: 0 8px 0px rgba(74, 124, 89, 0.08);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .std-card:hover {
            transform: translateY(-4px) rotate(0.2deg);
            box-shadow: 0 15px 30px -10px rgba(74, 124, 89, 0.15);
        }

        .nav-standard {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-top: 3px solid var(--ghibli-leaf);
        }

        .nav-active {
            color: var(--ghibli-forest);
            transform: scale(1.05);
        }
        .nav-active::after {
            content: 'ğŸƒ';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
        }

        input, select, textarea {
            border: 2px solid #E9EED9 !important;
            border-radius: 16px !important;
            padding: 10px 16px !important;
            background: #FFFFFF !important;
            font-weight: 600 !important;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--ghibli-leaf) !important;
            outline: none !important;
            box-shadow: 0 0 0 4px rgba(167, 201, 87, 0.1) !important;
        }

        .status-check {
            width: 32px;
            height: 32px;
            border: 3px solid #CBD5E1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .status-check.active {
            background: var(--ghibli-forest);
            border-color: var(--ghibli-forest);
            box-shadow: 0 4px 10px rgba(74, 124, 89, 0.3);
        }

        .action-btn-sm {
            padding: 8px 14px;
            border-radius: 14px;
            transition: all 0.2s;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            border: 2px solid #E9EED9;
            background: #FFFFFF;
            gap: 6px;
            font-size: 13px;
            font-weight: 800;
            color: var(--ghibli-forest);
            box-shadow: 0 4px 0px #E9EED9;
        }
        .action-btn-sm:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0px #E9EED9;
        }

        .ghibli-header {
            background: linear-gradient(180deg, var(--ghibli-sky) 0%, #BFEFFF 100%);
            border-bottom: 4px solid var(--ghibli-forest);
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .float-icon { animation: floating 3s ease-in-out infinite; }

        .modal-overlay {
            background: rgba(62, 39, 35, 0.5);
            backdrop-filter: blur(8px);
            position: fixed;
            inset: 0;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- åˆå§‹åŒ–é…ç½® ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { 
  		apiKey: "AIzaSyDcNgcQWZTg2UijNW7LS4AnC6XQqjIaNVM",
		authDomain: "ghibli-list.firebaseapp.com",
  		projectId: "ghibli-list",
  		storageBucket: "ghibli-list.firebasestorage.app",
  		messagingSenderId: "730434760352",
  		appId: "1:730434760352:web:23190ab321a6261905e3c5",
  		measurementId: "G-P4FCQLMYLK"
		};
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : "ghibli-pro-app";

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const { useState, useEffect, useMemo, useRef } = React;

        // ç©©å®šçš„é›¢ç·šåœ–ç¤ºæ¸²æŸ“çµ„ä»¶
        const Icon = ({ name, size = 18, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide) {
                    const container = document.createElement('div');
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    container.appendChild(i);
                    window.lucide.createIcons({
                        root: container,
                        attrs: { width: size, height: size, class: className }
                    });
                    setSvgHtml(container.innerHTML);
                }
            }, [name, size, className]);
            if (!svgHtml) return <span style={{ width: size, height: size, display: 'inline-block' }} className={className} />;
            return <span className="inline-flex shrink-0" dangerouslySetInnerHTML={{ __html: svgHtml }} />;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [categories, setCategories] = useState([]);
            const [expenseItems, setExpenseItems] = useState([]); 
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('list'); 
            const [sortBy, setSortBy] = useState('date_asc'); 
            const [filterCat, setFilterCat] = useState('All');
            const [filterOwner, setFilterOwner] = useState('All');
            const [filterExpItem, setFilterExpItem] = useState('All'); 
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');
            
            // é—œéµå­—ç¯©é¸ç›¸é—œç‹€æ…‹
            const [filterKeyword, setFilterKeyword] = useState(''); // çœŸæ­£éæ¿¾ç”¨çš„å€¼
            const [tempKeyword, setTempKeyword] = useState('');    // è¼¸å…¥æ¡†æš«å­˜çš„å€¼

            const chartRefs = useRef({ trend: null, cat: null, owner: null, item: null });

            // è¡¨å–®ç‹€æ…‹
            const [expenseModalTask, setExpenseModalTask] = useState(null);
            const [modalExpenses, setModalExpenses] = useState([]);
            const [taskText, setTaskText] = useState('');
            const [owner, setOwner] = useState('Terry');
            const [category, setCategory] = useState('');
            const [note, setNote] = useState('');
            const [dateMode, setDateMode] = useState('single');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [links, setLinks] = useState([{ label: '', url: '' }]);
            const [editingId, setEditingId] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState('');
            const [newExpenseItemName, setNewExpenseItemName] = useState('');
            const [showCatAdmin, setShowCatAdmin] = useState(false);
            const [showExpItemAdmin, setShowExpItemAdmin] = useState(false);

            // èº«ä»½é©—è­‰
            useEffect(() => {
                const login = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                login().catch(console.error);
                return auth.onAuthStateChanged(u => setUser(u));
            }, []);

            // è³‡æ–™ç›£è½
            useEffect(() => {
                if (!user) return;
                const path = db.collection('artifacts').doc(appId).collection('public').doc('data');
                
                const unsubTasks = path.collection('tasks').onSnapshot(snap => {
                    setTasks(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                });

                const unsubCats = path.collection('categories').onSnapshot(snap => {
                    let d = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (d.length === 0) {
                        ['æ—¥å¸¸', 'å†’éšª', 'ç¾é£Ÿ', 'å­¸ç¿’', 'æ¸…å–®'].forEach(name => path.collection('categories').add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                    }
                    setCategories(d.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0)));
                    if (d.length > 0 && !category) setCategory(d[0].name);
                });

                const unsubExpItems = path.collection('expenseItems').onSnapshot(snap => {
                    let d = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (d.length === 0) {
                        ['é¤è²»', 'äº¤é€š', 'é–€ç¥¨', 'è³¼ç‰©', 'ä½å®¿'].forEach(name => path.collection('expenseItems').add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() }));
                    }
                    setExpenseItems(d.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0)));
                });

                return () => { unsubTasks(); unsubCats(); unsubExpItems(); };
            }, [user]);

            const calculateTaskTotal = (t) => (t.expenses || []).reduce((s, i) => s + (parseFloat(i.amount) || 0), 0);

            // è³‡æ–™éæ¿¾èˆ‡æ’åº (æ•´åˆé—œéµå­—)
            const sortedTasks = useMemo(() => {
                let res = [...tasks];
                if (filterCat !== 'All') res = res.filter(t => t.category === filterCat);
                if (filterOwner !== 'All') res = res.filter(t => t.owner === filterOwner);
                
                if (filterExpItem !== 'All') {
                    res = res.filter(t => (t.expenses || []).some(e => e.item === filterExpItem));
                }

                if (filterStartDate) res = res.filter(t => (t.startDate || t.dueDate || '0000-00-00') >= filterStartDate);
                if (filterEndDate) res = res.filter(t => (t.startDate || t.dueDate || '9999-99-99') <= filterEndDate);
                
                if (filterKeyword.trim()) {
                    const kw = filterKeyword.toLowerCase();
                    res = res.filter(t => 
                        t.text.toLowerCase().includes(kw) || 
                        (t.note && t.note.toLowerCase().includes(kw))
                    );
                }

                res.sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    if (sortBy === 'category') return (a.category || '').localeCompare(b.category || '');
                    const d1 = a.startDate || a.dueDate || (sortBy === 'date_asc' ? '9999-12-31' : '0000-01-01');
                    const d2 = b.startDate || b.dueDate || (sortBy === 'date_asc' ? '9999-12-31' : '0000-01-01');
                    return sortBy === 'date_asc' ? d1.localeCompare(d2) : d2.localeCompare(d1);
                });
                return res;
            }, [tasks, filterCat, filterOwner, filterExpItem, filterStartDate, filterEndDate, filterKeyword, sortBy]);

            const activeTasks = useMemo(() => sortedTasks.filter(t => !t.completed), [sortedTasks]);
            const historyTasks = useMemo(() => sortedTasks.filter(t => t.completed), [sortedTasks]);
            const grandTotal = useMemo(() => historyTasks.reduce((s, t) => s + calculateTaskTotal(t), 0), [historyTasks]);

            // åˆ†ææ¸²æŸ“
            useEffect(() => {
                if (activeTab !== 'analytics' || sortedTasks.length === 0) return;
                const timer = setTimeout(() => {
                    Object.values(chartRefs.current).forEach(c => c && c.destroy());
                    const catMap = {}, ownerMap = { Terry: 0, Eric: 0 }, itemMap = {}, trendMap = {};

                    let minD = filterStartDate, maxD = filterEndDate;
                    if (!minD || !maxD) {
                        let dataMin = '9999-12-31', dataMax = '0000-01-01';
                        sortedTasks.forEach(t => {
                            (t.expenses || []).forEach(e => {
                                if (e.date && e.date < dataMin) dataMin = e.date;
                                if (e.date && e.date > dataMax) dataMax = e.date;
                            });
                        });
                        if (!minD || minD === '9999-12-31') minD = dataMin;
                        if (!maxD || maxD === '0000-01-01') maxD = dataMax;
                    }

                    const diffDays = Math.ceil(Math.abs(new Date(maxD) - new Date(minD)) / 86400000);
                    let mode = diffDays > 365 ? 'yearly' : diffDays > 31 ? 'monthly' : 'daily';

                    sortedTasks.forEach(t => {
                        const total = calculateTaskTotal(t);
                        catMap[t.category] = (catMap[t.category] || 0) + total;
                        if (t.owner === 'Terry' || t.owner === 'Eric') ownerMap[t.owner] += total;
                        
                        (t.expenses || []).forEach(e => {
                            if (e.item) itemMap[e.item] = (itemMap[e.item] || 0) + parseFloat(e.amount || 0);
                            if (e.date) {
                                let key = '', label = '';
                                if (mode === 'yearly') {
                                    key = e.date.substring(0, 4); label = key + 'å¹´';
                                } else if (mode === 'monthly') {
                                    key = e.date.substring(0, 7);
                                    const monthNum = parseInt(e.date.substring(5, 7));
                                    label = (minD.substring(0,4) !== maxD.substring(0,4)) ? key : monthNum + 'æœˆ';
                                } else {
                                    key = e.date; label = e.date.substring(5).replace('-', '/');
                                }
                                if (!trendMap[key]) trendMap[key] = { label, amount: 0 };
                                trendMap[key].amount += parseFloat(e.amount || 0);
                            }
                        });
                    });

                    const sortedKeys = Object.keys(trendMap).sort();
                    const ctx1 = document.getElementById('trendChart')?.getContext('2d');
                    if (ctx1) chartRefs.current.trend = new Chart(ctx1, {
                        type: 'bar',
                        data: { labels: sortedKeys.map(k => trendMap[k].label), datasets: [{ data: sortedKeys.map(k => trendMap[k].amount), backgroundColor: '#4A7C59', borderRadius: 8 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });

                    const ctx2 = document.getElementById('catChart')?.getContext('2d');
                    if (ctx2) chartRefs.current.cat = new Chart(ctx2, {
                        type: 'doughnut',
                        data: { labels: Object.keys(catMap), datasets: [{ data: Object.values(catMap), backgroundColor: ['#4A7C59', '#A7C957', '#FFB74D', '#E9C46A', '#F4A261'] }] },
                        options: { cutout: '65%', plugins: { legend: { position: 'bottom' } } }
                    });

                    const ctx3 = document.getElementById('ownerChart')?.getContext('2d');
                    if (ctx3) chartRefs.current.owner = new Chart(ctx3, {
                        type: 'pie',
                        data: { labels: ['Terry', 'Eric'], datasets: [{ data: [ownerMap.Terry, ownerMap.Eric], backgroundColor: ['#4A7C59', '#FFB74D'] }] },
                        options: { plugins: { legend: { position: 'bottom' } } }
                    });

                    const sortedItems = Object.entries(itemMap).sort((a,b) => b[1] - a[1]);
                    const ctx4 = document.getElementById('itemChart')?.getContext('2d');
                    if (ctx4) chartRefs.current.item = new Chart(ctx4, {
                        type: 'bar',
                        data: { labels: sortedItems.map(i => i[0]), datasets: [{ label: 'ç¸½æ”¯å‡º', data: sortedItems.map(i => i[1]), backgroundColor: '#A7C957', borderRadius: 6 }] },
                        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }, 250);
                return () => clearTimeout(timer);
            }, [activeTab, sortedTasks, filterStartDate, filterEndDate]);

            // --- æ ¸å¿ƒå‹•ä½œ ---
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (dateMode === 'range' && startDate && endDate && endDate < startDate) return; 
                if (!taskText.trim() || isProcessing || !user) return;
                setIsProcessing(true);
                const data = {
                    text: taskText.trim(), owner, category, note, dateMode, startDate, endDate: dateMode === 'range' ? endDate : '',
                    links: links.filter(l => l.url.trim() !== ''),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks');
                    if (editingId) await ref.doc(editingId).update(data);
                    else await ref.add({ ...data, completed: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    setActiveTab('list'); resetForm();
                } catch (err) { alert("å„²å­˜å¤±æ•—"); }
                setIsProcessing(false);
            };

            const saveModalExpenses = async () => {
                if (!expenseModalTask || !user) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(expenseModalTask.id).update({
                        expenses: modalExpenses.filter(e => e.item && e.item.trim() !== '' && e.amount)
                    });
                    setExpenseModalTask(null);
                } catch (err) { alert("æ›´æ–°å¤±æ•—"); }
            };

            const handleSearchSubmit = () => {
                setFilterKeyword(tempKeyword);
            };

            const clearFilters = () => {
                setFilterCat('All');
                setFilterOwner('All');
                setFilterExpItem('All'); 
                setFilterStartDate('');
                setFilterEndDate('');
                setFilterKeyword('');
                setTempKeyword('');
            };

            const resetForm = () => {
                setTaskText(''); setNote(''); setStartDate(''); setEndDate(''); setLinks([{ label: '', url: '' }]);
                setEditingId(null); setDateMode('single'); setShowCatAdmin(false);
            };

            const startEdit = (t) => {
                setTaskText(t.text); setOwner(t.owner); setCategory(t.category); setNote(t.note || '');
                setDateMode(t.dateMode || 'single'); setStartDate(t.startDate || t.dueDate || ''); setEndDate(t.endDate || '');
                setLinks(t.links?.length ? t.links : [{ label: '', url: '' }]);
                setEditingId(t.id); setActiveTab('add');
            };

            const addExpenseItem = async () => {
                if (!newExpenseItemName.trim()) return;
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenseItems').add({
                    name: newExpenseItemName.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setNewExpenseItemName('');
            };

            const isFilterDateInvalid = filterStartDate && filterEndDate && filterEndDate < filterStartDate;
            const isAddDateInvalid = dateMode === 'range' && startDate && endDate && endDate < startDate;

            return (
                <div className="max-w-2xl mx-auto min-h-screen flex flex-col bg-[#FDFCF0]">
                    <header className="ghibli-header px-8 py-10 flex flex-col items-center justify-center sticky top-0 z-30 shadow-md">
                        <div className="flex items-center gap-4">
                            <div className="bg-white/40 p-3 rounded-full border-2 border-white/50 backdrop-blur-sm float-icon">
                                <Icon name="leaf" size={32} className="text-emerald-700" />
                            </div>
                            <div className="text-center">
                                <h1 className="text-3xl font-black text-emerald-950 tracking-widest drop-shadow-sm">æ¸…å–®ç´€éŒ„</h1>
                                <p className="text-[10px] font-black text-emerald-700 uppercase tracking-[0.4em] mt-1 opacity-70">Terry & Eric Notebook</p>
                            </div>
                        </div>
                        <Icon name="cloud" className="absolute top-4 right-10 text-white/40" size={80} />
                    </header>

                    <main className="flex-grow px-5 py-8 pb-44">
                        {activeTab === 'list' || activeTab === 'history' ? (
                            <div className="animate-fade-in">
                                {/* ç¯©é¸å€å¡Š */}
                                <div className="flex flex-col gap-4 mb-8 bg-white p-6 rounded-[2rem] border-2 border-[#E9EED9] shadow-sm relative overflow-hidden">
                                    <Icon name="wind" className="absolute -top-2 -right-2 text-emerald-50 opacity-50" size={60} />
                                    
                                    <div className="flex items-center justify-between gap-2 z-10">
                                        {/* ä¿®æ”¹ï¼šå¯¬åº¦æ‹‰é•·è‡³ 280px */}
                                        <div className="w-[280px] flex items-center bg-[#F9FBF2] rounded-full px-4 border border-[#E9EED9] shadow-inner">
                                            <input 
                                                type="text" 
                                                value={tempKeyword} 
                                                onChange={e => setTempKeyword(e.target.value)}
                                                onKeyDown={e => e.key === 'Enter' && handleSearchSubmit()}
                                                placeholder="é—œéµå­—..." 
                                                className="w-full bg-transparent border-none text-[11px] font-black p-2 outline-none"
                                            />
                                            <button onClick={handleSearchSubmit} className="p-1.5 text-emerald-500 hover:text-emerald-700 transition-colors">
                                                <Icon name="search" size={16} />
                                            </button>
                                        </div>
                                        <button onClick={clearFilters} className="text-[10px] bg-rose-50 text-rose-500 font-black px-4 py-2.5 rounded-full whitespace-nowrap hover:bg-rose-100 transition-colors shadow-sm">
                                            æ¸…ç©ºç¯©é¸
                                        </button>
                                    </div>

                                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 z-10">
                                        <select value={filterCat} onChange={e => setFilterCat(e.target.value)} className="text-xs bg-[#F9FBF2] font-black border-none !py-2 rounded-full px-4 min-w-[100px]">
                                            <option value="All">é¡åˆ¥ç¯©é¸</option>
                                            {categories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                        </select>
                                        <select value={filterOwner} onChange={e => setFilterOwner(e.target.value)} className="text-xs bg-[#F9FBF2] font-black border-none !py-2 rounded-full px-4 min-w-[100px]">
                                            <option value="All">æˆå“¡é¸æ“‡</option>
                                            <option value="Terry">Terry</option>
                                            <option value="Eric">Eric</option>
                                        </select>
                                        <select value={filterExpItem} onChange={e => setFilterExpItem(e.target.value)} className="text-xs bg-amber-50/50 text-amber-700 font-black border-none !py-2 rounded-full px-4 min-w-[100px]">
                                            <option value="All">è²»ç”¨ç¯©é¸</option>
                                            {expenseItems.map(item => <option key={item.id} value={item.name}>{item.name}</option>)}
                                        </select>
                                        <select value={sortBy} onChange={e => setSortBy(e.target.value)} className="text-xs bg-[#F9FBF2] font-black border-none !py-2 rounded-full px-4 min-w-[100px]">
                                            <option value="date_asc">æ—¥æœŸèˆŠè‡³æ–°</option>
                                            <option value="date_desc">æ—¥æœŸæ–°è‡³èˆŠ</option>
                                        </select>
                                    </div>

                                    <div className="flex flex-col gap-1 pt-3 border-t border-[#F1F5E9] z-10">
                                        <div className="flex items-center gap-2">
                                            <Icon name="calendar" size={14} className="text-emerald-600" />
                                            <div className="flex items-center gap-2 w-full font-black">
                                                <input type="date" value={filterStartDate} onChange={e => setFilterStartDate(e.target.value)} className="text-xs w-full bg-[#F9FBF2] border-none !p-1.5 rounded-lg" />
                                                <span className="text-emerald-200">~</span>
                                                <input type="date" value={filterEndDate} onChange={e => setFilterEndDate(e.target.value)} className="text-xs w-full bg-[#F9FBF2] border-none !p-1.5 rounded-lg" />
                                            </div>
                                        </div>
                                        {isFilterDateInvalid && <p className="text-[9px] text-rose-500 font-bold ml-6 mt-1 flex items-center gap-1 animate-pulse"><Icon name="alert-circle" size={10} /> çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ</p>}
                                    </div>
                                </div>

                                {activeTab === 'history' && (
                                    <div className="bg-amber-50 p-5 rounded-2xl mb-8 border border-amber-100 flex justify-between items-center shadow-inner">
                                        <div className="flex items-center gap-3 text-indigo-900 font-bold text-sm"><Icon name="check-circle" size={20} className="text-indigo-600" /> å·²é”æˆèŠ±è²»åŠ ç¸½</div>
                                        <div className="text-3xl font-black text-emerald-800">$ {grandTotal.toLocaleString()}</div>
                                    </div>
                                )}
                                
                                {loading ? <div className="text-center py-24 font-bold text-slate-300 flex flex-col items-center gap-4 animate-pulse"><Icon name="loader" size={40} className="animate-spin text-indigo-300" /> è³‡æ–™è®€å–ä¸­...</div> :
                                (activeTab === 'list' ? activeTasks : historyTasks).map(t => {
                                    const total = calculateTaskTotal(t);
                                    const isCompact = !t.note && (!t.links || t.links.length === 0);
                                    return (
                                        <div key={t.id} className={`std-card mb-5 relative flex flex-col ${t.completed ? 'opacity-50 grayscale border-slate-200 bg-slate-50 shadow-none' : ''} ${isCompact ? 'p-5 gap-3' : 'p-7 gap-6'}`}>
                                            <div className="flex items-start gap-4">
                                                <div onClick={() => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(t.id).update({ completed: !t.completed, completedAt: !t.completed ? firebase.firestore.FieldValue.serverTimestamp() : null })}
                                                    className={`status-check flex-shrink-0 mt-1 shadow-sm ${t.completed ? 'active' : ''}`}><Icon name="check" size={16} color="white" /></div>
                                                <div className="flex-grow min-w-0">
                                                    <div className="flex flex-wrap items-center gap-2 mb-2">
                                                        <h3 className={`${isCompact ? 'text-lg' : 'text-xl'} font-bold text-slate-800 leading-tight tracking-tight uppercase`}>{t.text}</h3>
                                                        <div className="flex gap-2">
                                                            <span className="text-[10px] bg-indigo-50 text-indigo-600 px-2.5 py-0.5 rounded-full font-black border border-indigo-100 uppercase">{t.owner}</span>
                                                            <span className="text-[10px] bg-slate-100 text-slate-600 px-2.5 py-0.5 rounded-full font-black border border-slate-200 uppercase">{t.category}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex flex-wrap gap-5 mb-4 text-[11px] font-bold text-slate-400">
                                                        {total > 0 && <div className="flex items-center gap-1.5 text-amber-600 bg-amber-50 px-2 rounded-full font-black"><Icon name="wallet" size={14} /> ${total.toLocaleString()}</div>}
                                                        {(t.startDate || t.dueDate) && <div className="flex items-center gap-1.5 bg-white border border-slate-100 px-2 rounded-full font-black"><Icon name="calendar" size={14} /> {t.startDate || t.dueDate}{t.endDate && ` ~ ${t.endDate}`}</div>}
                                                    </div>
                                                    {t.note && <p className="text-sm text-slate-500 bg-emerald-50/20 p-4 rounded-2xl italic leading-relaxed mb-1 shadow-inner whitespace-pre-line border border-white/50">{t.note}</p>}
                                                    {!t.completed && t.links && t.links.length > 0 && (
                                                        <div className="flex flex-wrap gap-2 mt-2">{t.links.map((l, i) => <a key={i} href={l.url} target="_blank" className="text-[11px] bg-white border-2 border-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-2 hover:border-emerald-500 hover:text-white transition-all shadow-sm"><Icon name="link" size={12} /> {l.label || "é€£çµ"}</a>)}</div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-end pt-3 border-t-2 border-emerald-50/50 gap-4">
                                                {!t.completed && <button onClick={() => { setExpenseModalTask(t); const defDate = t.startDate || t.dueDate || new Date().toISOString().split('T')[0]; setModalExpenses(t.expenses?.length ? [...t.expenses] : [{ date: defDate, item: '', desc: '', amount: '' }]); }} className="action-btn-sm text-amber-600 border-amber-100"><Icon name="wallet" size={18} /><span>è²»ç”¨</span></button>}
                                                {!t.completed && <button onClick={() => startEdit(t)} className="action-btn-sm text-indigo-600 border-indigo-100"><Icon name="edit-3" size={18} /><span>ä¿®æ”¹</span></button>}
                                                <button onClick={() => confirm("è¦æ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„å—ï¼Ÿ") && db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(t.id).delete()} className="action-btn-sm text-rose-50 border-rose-100"><Icon name="trash-2" size={18} /><span>åˆªé™¤</span></button>
                                            </div>
                                        </div>
                                    );
                                })}
                                {(activeTab === 'list' ? activeTasks : historyTasks).length === 0 && <div className="text-center py-24 text-slate-300 font-bold border-4 border-dashed border-slate-100 rounded-[3rem] bg-white/50 flex flex-col items-center gap-4 animate-fade-in"><Icon name="wind" size={64} /> é€™è£¡ç›®å‰ç©ºç©ºå¦‚ä¹Ÿ ğŸŒ¿</div>}
                            </div>
                        ) : activeTab === 'add' ? (
                            <div className="animate-fade-in std-card p-8 md:p-12 relative overflow-hidden">
                                <Icon name="wind" className="absolute -bottom-4 -left-4 text-emerald-50 opacity-40" size={120} />
                                <h2 className="text-2xl font-black text-emerald-950 flex items-center gap-4 mb-10"><Icon name="plus-circle" size={32} className="text-emerald-600" />æ–°å¢äº‹é …</h2>
                                <form onSubmit={handleSubmit} className="space-y-10 relative z-10">
                                    <div><label className="text-xs font-black text-emerald-600 uppercase tracking-widest mb-2 block">äº‹é …ä¸»é¡Œ Subject</label><input className="w-full text-xl font-black shadow-sm" value={taskText} onChange={e => setTaskText(e.target.value)} placeholder="æƒ³è¦ç´€éŒ„ä»€éº¼ï¼Ÿ" required /></div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div><label className="text-xs font-black text-emerald-600 uppercase tracking-widest mb-2 block">æ­¸å±¬æˆå“¡</label><select className="w-full font-black cursor-pointer shadow-sm" value={owner} onChange={e => setOwner(e.target.value)}><option value="Terry">Terry</option><option value="Eric">Eric</option></select></div>
                                        <div><div className="flex justify-between items-center mb-2"><label className="text-xs font-black text-emerald-600 uppercase tracking-widest">é¡åˆ¥</label><button type="button" onClick={()=>setShowCatAdmin(!showCatAdmin)} className="text-[11px] text-emerald-600 font-black underline">ç®¡ç†</button></div>
                                        <select className="w-full font-black cursor-pointer shadow-sm" value={category} onChange={e => setCategory(e.target.value)}>{categories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}</select></div>
                                    </div>
                                    {showCatAdmin && (
                                        <div className="p-5 bg-emerald-50 rounded-[2rem] border-2 border-emerald-100 border-dashed animate-fade-in">
                                            <div className="flex flex-wrap gap-2 mb-4">{categories.map(cat => <span key={cat.id} className="bg-white border-2 border-emerald-100 px-3 py-1.5 rounded-xl text-[11px] font-bold flex items-center gap-2 text-emerald-700 shadow-sm">{cat.name}<button type="button" onClick={()=>db.collection('artifacts').doc(appId).collection('public').doc('data').collection('categories').doc(cat.id).delete()} className="text-rose-400"><Icon name="x" size={10} /></button></span>)}</div>
                                            <div className="flex gap-3"><input className="flex-grow !py-2 !px-4 text-sm font-black bg-white shadow-sm rounded-xl" placeholder="æ–°é¡åˆ¥åç¨±" value={newCategoryName} onChange={e=>setNewCategoryName(e.target.value)} /><button type="button" onClick={()=>{ if(!newCategoryName.trim())return; db.collection('artifacts').doc(appId).collection('public').doc('data').collection('categories').add({name: newCategoryName.trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp()}); setNewCategoryName(''); }} className="bg-emerald-600 text-white px-5 rounded-xl text-xs font-black shadow-md">æ–°å¢</button></div>
                                        </div>
                                    )}
                                    <div><label className="text-xs font-black text-emerald-600 uppercase tracking-widest mb-3 block">æ—¥æœŸè¨­å®š Date Setting</label>
                                        <div className="flex gap-3 mb-4">{['single', 'range'].map(m => <button key={m} type="button" onClick={() => setDateMode(m)} className={`flex-1 py-3 rounded-2xl font-black text-sm border-2 transition-all ${dateMode === m ? 'bg-emerald-600 text-white border-emerald-600 shadow-md' : 'bg-white text-emerald-500 border-emerald-100'}`}>{m === 'single' ? "å–®ä¸€æ—¥æœŸ" : "æ—¥æœŸå€é–“"}</button>)}</div>
                                        <div className="grid grid-cols-2 gap-4 p-6 bg-[#F9FBF2] rounded-[2rem] border-2 border-emerald-50 shadow-inner font-black"><div className="space-y-1"><label className="text-[9px] text-slate-400">é–‹å§‹</label><input type="date" className="w-full !p-1.5 text-xs font-bold bg-transparent border-none" value={startDate} onChange={e => setStartDate(e.target.value)} /></div>{dateMode === 'range' && <div className="space-y-1"><label className="text-[9px] text-slate-400">çµæŸ</label><input type="date" className="w-full !p-1.5 text-xs font-bold bg-transparent border-none" value={endDate} onChange={e => setEndDate(e.target.value)} /></div>}</div>
                                        {isAddDateInvalid && <p className="text-[10px] text-rose-500 font-black mt-2 flex items-center gap-2 animate-pulse"><Icon name="alert-triangle" size={14} /> çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸ</p>}
                                    </div>
                                    <div><div className="flex justify-between items-center mb-3"><label className="text-xs font-black text-emerald-600 uppercase tracking-widest">ç›¸é—œé€£çµè³‡æº Links</label><button type="button" onClick={() => setLinks([...links, { label: '', url: '' }])} className="text-[10px] text-indigo-600 font-bold underline">+ æ–°å¢é€£çµ</button></div>
                                        <div className="space-y-3">{links.map((li, i) => (<div key={i} className="flex gap-3 items-center p-3 bg-white border border-slate-200 rounded-xl shadow-sm animate-fade-in"><input className="flex-1 !p-2 text-xs bg-slate-50 font-bold" placeholder="æ¨™ç±¤ (å¦‚: åœ°é»)" value={li.label} onChange={e => { const n = [...links]; n[i].label = e.target.value; setLinks(n); }} /><input className="flex-1 !p-2 text-xs bg-slate-50 text-indigo-600 font-black" placeholder="https://..." value={li.url} onChange={e => { const n = [...links]; n[i].url = e.target.value; setLinks(n); }} />{links.length > 1 && <button type="button" onClick={() => setLinks(links.filter((_, idx) => idx !== i))} className="p-1.5 text-rose-300 hover:text-rose-600"><Icon name="trash-2" size={18} /></button>}</div>))}</div></div>
                                    <div><label className="text-xs font-black text-emerald-600 uppercase tracking-widest mb-2 block">è©³ç´°å‚™è¨» Notes</label><textarea className="w-full min-h-[120px] text-sm leading-relaxed font-bold border-none bg-[#F9FBF2] rounded-[1.5rem] shadow-inner p-5" value={note} onChange={e => setNote(e.target.value)} placeholder="è¼¸å…¥ç´°ç¯€ç´€éŒ„..." /></div>
                                    <button type="submit" disabled={isProcessing || isAddDateInvalid} className="w-full h-16 bg-emerald-600 text-white rounded-[2rem] font-black shadow-xl shadow-emerald-100 hover:bg-emerald-700 active:scale-[0.98] transition-all flex items-center justify-center gap-3 tracking-widest text-lg disabled:opacity-50">
                                        {isProcessing ? <Icon name="loader" className="animate-spin" /> : <Icon name="sparkles" size={24} />}æ–°å¢æ¸…å–®
                                    </button>
                                </form>
                            </div>
                        ) : activeTab === 'analytics' ? (
                            <div className="animate-fade-in space-y-8">
                                <div className="grid grid-cols-2 gap-4 text-center font-black">
                                    <div className="std-card p-5"><p className="text-[10px] text-slate-400 uppercase mb-1">å€åŸŸé …ç›®</p><p className="text-3xl font-black">{sortedTasks.length}</p></div>
                                    <div className="std-card p-5"><p className="text-[10px] text-slate-400 uppercase mb-1">èŠ±è²»ç¸½è¨ˆ</p><p className="text-3xl font-black text-indigo-600">${sortedTasks.reduce((s,t)=>s+calculateTaskTotal(t),0).toLocaleString()}</p></div>
                                </div>
                                <div className="std-card p-8 shadow-sm"><h3 className="text-sm font-bold mb-6 flex items-center gap-2 text-slate-700 uppercase tracking-widest"><Icon name="trending-up" className="text-indigo-600" /> æ”¯å‡ºè¶¨å‹¢åˆ†æ</h3><div className="h-64"><canvas id="trendChart"></canvas></div></div>
                                <div className="std-card p-8 shadow-sm"><h3 className="text-sm font-bold mb-6 flex items-center gap-2 text-slate-700 uppercase tracking-widest"><Icon name="bar-chart-2" className="text-indigo-600" /> é …ç›®è²»ç”¨åˆ†æ</h3><div className="h-80"><canvas id="itemChart"></canvas></div></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="std-card p-6 shadow-sm"><h3 className="text-sm font-bold mb-6 flex items-center gap-2 text-slate-700 uppercase tracking-widest"><Icon name="pie-chart" className="text-indigo-600" /> é¡åˆ¥åˆ†ä½ˆ</h3><canvas id="catChart"></canvas></div>
                                    <div className="std-card p-6 shadow-sm"><h3 className="text-sm font-bold mb-6 flex items-center gap-2 text-slate-700 uppercase tracking-widest"><Icon name="users" className="text-indigo-600" /> æˆå“¡çµ±è¨ˆ</h3><canvas id="ownerChart"></canvas></div>
                                </div>
                            </div>
                        ) : null}
                    </main>

                    {/* æ”¯å‡ºç´°ç¯€ç¶­è­·å½ˆçª— (Modal) */}
                    {expenseModalTask && (
                        <div className="modal-overlay flex items-center justify-center p-6 animate-in zoom-in-95 duration-200" onClick={() => setExpenseModalTask(null)}>
                            <div className="bg-white w-full max-w-md p-10 rounded-[3rem] shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-8"><h3 className="text-xl font-bold flex items-center gap-3 text-slate-800"><div className="bg-amber-100 p-3 rounded-2xl text-amber-600 shadow-md"><Icon name="coins" size={24} /></div> è²»ç”¨ç´°ç¯€ç¶­è­·</h3><button onClick={() => setExpenseModalTask(null)} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><Icon name="x" size={24} className="text-slate-400" /></button></div>
                                
                                <div className="mb-6">
                                    <div className="flex justify-between items-center mb-2"><label className="text-[11px] font-black text-slate-400 uppercase tracking-widest">å¸¸ç”¨è²»ç”¨é …ç›®ç®¡ç†</label><button onClick={() => setShowExpItemAdmin(!showExpItemAdmin)} className="text-[10px] text-indigo-600 underline font-bold">{showExpItemAdmin ? "å®Œæˆç®¡ç†" : "ç®¡ç†é …ç›®"}</button></div>
                                    {showExpItemAdmin && (
                                        <div className="p-4 bg-amber-50/50 rounded-2xl border border-amber-100 mb-4 animate-fade-in">
                                            <div className="flex flex-wrap gap-1.5 mb-3">{expenseItems.map(item => (<span key={item.id} className="bg-white border px-2 py-1 rounded-lg text-[10px] font-black flex items-center gap-1.5 shadow-sm">{item.name}<button onClick={() => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('expenseItems').doc(item.id).delete()} className="text-red-300 hover:text-red-500 transition-colors"><Icon name="x" size={10} /></button></span>))}</div>
                                            <div className="flex gap-2"><input className="flex-grow !py-1 !px-3 text-xs bg-white" placeholder="æ–°é …ç›®åç¨±" value={newExpenseItemName} onChange={e => setNewExpenseItemName(e.target.value)} /><button onClick={addExpenseItem} className="bg-amber-500 text-white px-3 py-1 rounded-lg text-[10px] font-black shadow-sm">æ–°å¢</button></div>
                                        </div>
                                    )}
                                </div>

                                <div className="max-h-[50vh] overflow-y-auto pr-1 no-scrollbar mb-10 space-y-5">
                                    {modalExpenses.map((ex, i) => (
                                        <div key={i} className="p-5 bg-slate-50 rounded-[2rem] border border-slate-100 relative space-y-4 shadow-inner">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="space-y-1"><label className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">æ—¥æœŸ</label><input type="date" value={ex.date} onChange={e => { const n = [...modalExpenses]; n[i].date = e.target.value; setModalExpenses(n); }} className="w-full !p-2 text-xs border-none bg-white font-black rounded-xl shadow-sm" /></div>
                                                <div className="space-y-1"><label className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">é‡‘é¡</label><input type="number" placeholder="é‡‘é¡" value={ex.amount} onChange={e => { const n = [...modalExpenses]; n[i].amount = e.target.value; setModalExpenses(n); }} className="w-full !p-2 text-xs border-none bg-white font-black text-indigo-600 rounded-xl shadow-sm" /></div>
                                            </div>
                                            <div className="grid grid-cols-1 gap-4">
                                                <div className="space-y-1"><label className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">é …ç›®</label>
                                                    <select value={ex.item} onChange={e => { const n = [...modalExpenses]; n[i].item = e.target.value; setModalExpenses(n); }} className="w-full !p-2 text-xs border-none bg-white font-black rounded-xl shadow-sm">
                                                        <option value="">é¸æ“‡é …ç›®...</option>
                                                        {expenseItems.map(opt => <option key={opt.id} value={opt.name}>{opt.name}</option>)}
                                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                                    </select>
                                                </div>
                                                <div className="space-y-1"><label className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">èªªæ˜</label><input placeholder="èªªæ˜" value={ex.desc} onChange={e => { const n = [...modalExpenses]; n[i].desc = e.target.value; setModalExpenses(n); }} className="w-full !p-2 text-xs border-none bg-white rounded-xl shadow-sm" /></div>
                                            </div>
                                            <button type="button" onClick={() => setModalExpenses(modalExpenses.filter((_, idx) => idx !== i))} className="absolute -top-3 -right-3 bg-white text-rose-500 border-2 border-rose-50 rounded-full p-2 shadow-lg hover:bg-rose-50"><Icon name="x" size={14} /></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-4">
                                    <button onClick={() => {
                                        const defDate = expenseModalTask.startDate || expenseModalTask.dueDate || new Date().toISOString().split('T')[0];
                                        setModalExpenses([{ date: defDate, item: '', desc: '', amount: '' }, ...modalExpenses]);
                                    }} className="flex-1 py-4 bg-slate-50 text-slate-600 rounded-2xl text-xs font-black border border-slate-200 shadow-sm hover:bg-slate-100 transition-all">+ æ–°å¢è²»ç”¨</button>
                                    <button onClick={saveModalExpenses} className="flex-1 py-4 bg-indigo-600 text-white rounded-2xl text-xs font-black shadow-xl shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition-all">å„²å­˜è®Šæ›´å…§å®¹</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 nav-standard h-24 flex items-center z-40 px-6 shadow-[0_-10px_40px_rgba(74,124,89,0.05)]">
                        <div className="max-w-xl mx-auto w-full grid grid-cols-4 gap-2 text-center font-black">
                            <button onClick={() => setActiveTab('list')} className={`flex flex-col items-center justify-center gap-1.5 py-3 relative transition-all duration-300 ${activeTab === 'list' ? 'nav-active' : 'text-slate-400 hover:text-slate-600'}`}>
                                <Icon name="layout-list" size={26} /><span className="text-[11px] font-bold">æ¸…å–®</span>
                            </button>
                            <button onClick={() => { resetForm(); setActiveTab('add'); }} className={`flex flex-col items-center justify-center gap-1.5 py-3 relative transition-all duration-300 ${activeTab === 'add' || activeTab === 'edit' ? 'nav-active' : 'text-slate-400 hover:text-slate-600'}`}>
                                <Icon name="plus-square" size={26} /><span className="text-[11px] font-bold">æ–°å¢</span>
                            </button>
                            <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center justify-center gap-1.5 py-3 relative transition-all duration-300 ${activeTab === 'history' ? 'nav-active' : 'text-slate-400 hover:text-slate-600'}`}>
                                <Icon name="clock" size={26} /><span className="text-[11px] font-bold">ç´€éŒ„</span>
                            </button>
                            <button onClick={() => setActiveTab('analytics')} className={`flex flex-col items-center justify-center gap-1.5 py-3 relative transition-all duration-300 ${activeTab === 'analytics' ? 'nav-active' : 'text-slate-400 hover:text-slate-600'}`}>
                                <Icon name="pie-chart" size={26} /><span className="text-[11px] font-bold">çµ±è¨ˆ</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>